# Semantic Layer Configuration for BFSI Domain
# This layer maps business terminology to database schema

database:
  path: "database/bfsi_olap.duckdb"
  type: "duckdb"

# Define business metrics with SQL logic
metrics:
  total_transactions:
    description: "Total number of transactions"
    sql: "COUNT(DISTINCT transaction_key)"
    table: "fact_transactions"
    aggregation: "count"

  transaction_volume:
    description: "Total transaction amount"
    sql: "SUM(transaction_amount)"
    table: "fact_transactions"
    aggregation: "sum"
    format: "currency"

  average_transaction_amount:
    description: "Average transaction amount"
    sql: "AVG(transaction_amount)"
    table: "fact_transactions"
    aggregation: "avg"
    format: "currency"

  total_deposits:
    description: "Total deposit amount"
    sql: "SUM(CASE WHEN tt.is_credit = true THEN ft.transaction_amount ELSE 0 END)"
    table: "fact_transactions ft JOIN dim_transaction_type tt ON ft.transaction_type_key = tt.transaction_type_key"
    aggregation: "sum"
    format: "currency"

  total_withdrawals:
    description: "Total withdrawal amount"
    sql: "SUM(CASE WHEN tt.is_debit = true THEN ft.transaction_amount ELSE 0 END)"
    table: "fact_transactions ft JOIN dim_transaction_type tt ON ft.transaction_type_key = tt.transaction_type_key"
    aggregation: "sum"
    format: "currency"

  active_customers:
    description: "Number of active customers"
    sql: "COUNT(DISTINCT CASE WHEN c.customer_status = 'Active' THEN c.customer_key END)"
    table: "dim_customer c"
    aggregation: "count"

  total_loan_amount:
    description: "Total loan amount disbursed"
    sql: "SUM(loan_amount)"
    table: "fact_loans"
    aggregation: "sum"
    format: "currency"

  outstanding_loan_balance:
    description: "Total outstanding loan balance"
    sql: "SUM(outstanding_balance)"
    table: "fact_loans"
    aggregation: "sum"
    format: "currency"

  average_credit_score:
    description: "Average customer credit score"
    sql: "AVG(credit_score)"
    table: "dim_customer"
    aggregation: "avg"
    format: "number"

  loan_default_rate:
    description: "Percentage of loans in default"
    sql: "ROUND(100.0 * SUM(CASE WHEN default_flag = true THEN 1 ELSE 0 END) / COUNT(*), 2)"
    table: "fact_loans"
    aggregation: "custom"
    format: "percentage"

# Define dimensions for grouping and filtering
dimensions:
  date:
    table: "dim_date"
    key: "date_key"
    attributes:
      date: "date"
      year: "year"
      quarter: "quarter"
      month: "month"
      month_name: "month_name"
      week: "week"
      day_name: "day_name"
      is_weekend: "is_weekend"

  customer:
    table: "dim_customer"
    key: "customer_key"
    attributes:
      customer_id: "customer_id"
      name: "first_name || ' ' || last_name"
      age: "age"
      gender: "gender"
      occupation: "occupation"
      income_bracket: "income_bracket"
      credit_score: "credit_score"
      customer_segment: "customer_segment"
      city: "city"
      state: "state"
      customer_status: "customer_status"

  account:
    table: "dim_account"
    key: "account_key"
    attributes:
      account_id: "account_id"
      account_type: "account_type"
      account_subtype: "account_subtype"
      branch_name: "branch_name"
      region: "region"
      account_status: "account_status"

  transaction_type:
    table: "dim_transaction_type"
    key: "transaction_type_key"
    attributes:
      transaction_type: "transaction_type"
      transaction_category: "transaction_category"

  product:
    table: "dim_product"
    key: "product_key"
    attributes:
      product_name: "product_name"
      product_category: "product_category"
      product_type: "product_type"
      risk_level: "risk_level"

# Define common business terms and their mappings
business_terms:
  # Synonyms for metrics
  revenue: "transaction_volume"
  sales: "transaction_volume"
  income: "total_deposits"
  spending: "total_withdrawals"
  customers: "active_customers"
  users: "active_customers"
  loans: "total_loan_amount"
  debt: "outstanding_loan_balance"

  # Synonyms for dimensions
  time: "date"
  period: "date"
  when: "date"
  location: "region"
  where: "city"
  type: "account_type"
  category: "product_category"
  segment: "customer_segment"

  # Time periods
  today: "date = CURRENT_DATE"
  yesterday: "date = CURRENT_DATE - 1"
  this_week: "week = WEEK(CURRENT_DATE) AND year = YEAR(CURRENT_DATE)"
  this_month: "month = MONTH(CURRENT_DATE) AND year = YEAR(CURRENT_DATE)"
  this_year: "year = YEAR(CURRENT_DATE)"
  last_month: "month = MONTH(CURRENT_DATE - INTERVAL 1 MONTH) AND year = YEAR(CURRENT_DATE - INTERVAL 1 MONTH)"
  last_year: "year = YEAR(CURRENT_DATE) - 1"

# Define common query patterns
query_patterns:
  - pattern: "total|sum|how much"
    metric_type: "sum"

  - pattern: "average|mean|avg"
    metric_type: "avg"

  - pattern: "count|number of|how many"
    metric_type: "count"

  - pattern: "by day|daily|per day"
    group_by: "date"

  - pattern: "by month|monthly|per month"
    group_by: "month_name"

  - pattern: "by quarter|quarterly"
    group_by: "quarter"

  - pattern: "by year|yearly|annually"
    group_by: "year"

  - pattern: "by customer|per customer"
    group_by: "customer"

  - pattern: "by region|per region"
    group_by: "region"

  - pattern: "by account type|per account type"
    group_by: "account_type"

# Define fact table relationships
fact_tables:
  fact_transactions:
    primary_key: "transaction_key"
    dimensions:
      - "date"
      - "customer"
      - "account"
      - "transaction_type"
    measures:
      - "transaction_amount"
      - "transaction_fee"
      - "balance_after_transaction"

  fact_loans:
    primary_key: "loan_key"
    dimensions:
      - "date"
      - "customer"
      - "product"
    measures:
      - "loan_amount"
      - "outstanding_balance"
      - "principal_paid"
      - "interest_paid"
